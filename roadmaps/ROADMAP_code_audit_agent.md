# ROADMAP: Code Audit Agent

Цель: реализовать агента анализа проектов (папка с кодом) на основе существующих интерфейсов агента в репозитории, который выполняет комплексную проверку и возвращает результат в формате JSON.

## Этап 0. Подготовка и согласование
- [x] Уточнить формат входа: путь к локальной папке (Windows Desktop)
- [x] Уточнить целевые языки/типы проектов (Dart/Flutter, JS/TS/Node, Kotlin/Java; Python — позже)
- [x] Уточнить ограничения по размеру проекта и глубине обхода (игнорируемые директории, маски; лимит файлов: 20 в MVP)
- [x] Уточнить место интеграции: интегрировать в существующий экран `sample_app/lib/screens/auto_fix_screen.dart`
- [x] Уточнить необходимость оффлайн-работы и допустимость сетевых запросов: офлайн-эвристики (без сети в MVP)

## Этап 1. Архитектура и интерфейсы
- [x] Специфицировать новый агент `CodeAuditAgent` с использованием `IAgent`/`IStatefulAgent`/`IToolingAgent` из `sample_app/lib/agents/agent_interface.dart`
- [ ] Определить DTO для результата: `CodeAuditResult`, `FileAuditResult` в соответствии с JSON-форматом из задачи
- [x] Спроектировать стратегию анализа: пайплайн проходов по критериям (валидность, читаемость, зависимости, архитектура, тесты, безопасность, производительность, best practices)
- [x] Определить конфиг агента: глубина обхода, игнор-паттерны, максимально анализируемый размер файла, оценка токенов и чанкование анализа; лимит по количеству файлов снят (без лимита)

## Этап 2. Обход и индексация проекта
- [x] Реализовать безопасный обход файловой системы (Windows) с игнором типовых директорий (`.git/`, `build/`, `node_modules/`, `.dart_tool/`, `ios/Pods/`, `android/.gradle/`, и т.п.)
- [x] Детектировать тип проекта/модулей по наличию файлов-маркеров (`pubspec.yaml`, `package.json`, `build.gradle(.kts)`, `pom.xml`, `requirements.txt`, `pyproject.toml`)
- [x] Собирать карту файлов по языкам/расширениям и метаданные (размер, относительный путь) — без лимита по количеству файлов; ограничение по размерам файла остаётся для стабильности

## Этап 3. Анализ по критериям (базовый уровень)
- [x] Правильность кода: базовая проверка синтаксиса для поддерживаемых языков (либо через быстрые эвристики/парсеры без внешних зависимостей)
- [x] Читаемость: эвристики именования (snake_case/camelCase/PascalCase), длина функций/файлов, плотность комментариев
- [x] Анализ зависимостей: парсинг `pubspec.yaml`, `package.json`, `build.gradle(.кts)`; сбор версий; флаги потенциальной устарелости (без сетевых запросов, по семвер-эвристикам/локальным данным)
- [ ] Архитектура: простые метрики структуры (кол-во модулей/слоев, циклические зависимости на уровне путей/импортов — по эвристикам)
- [ ] Качество тестов: наличие тестовых директорий/файлов, базовая оценка покрытия по отношению к числу исходников (грубая)
- [x] Безопасность: поиск известных небезопасных паттернов (например, сохранение секретов, прямой доступ к FS/нет проверок входных данных) — эвристики и регулярные выражения
- [ ] Производительность: детектирование очевидных антипаттернов (вложенные циклы на больших коллекциях, синхронные блокирующие операции в UI-потоке и т.п.)
- [ ] Соответствие практикам: флаги по DRY/KISS/SOLID на уровне эвристик (дубликаты файлов/функций по хэшам, чрезмерно большие классы)

## Этап 4. Агрегация и формат вывода
- [ ] Свести результаты в структуру JSON:
  ```json
  {
    "summary": "Общий текст по проведенному анализу",
    "files": [
      { "file": "имя_файла", "suggestions": ["..."], "problems": ["..."] }
    ],
    "project_suggestions": ["..."]
  }
  ```
- [x] Реализовать ранжирование/приоритезацию проблем и рекомендаций
- [x] Добавить возможность экспорта результата в файл (например, `code_audit_result.json`)
- [x] Реализовать разбиение анализа на чанки по оценке токенов и склейку итогового ответа

## Этап 5. Интеграция в приложение
- [x] Интегрировать в существующий экран `sample_app/lib/screens/auto_fix_screen.dart`: добавить выбор папки проекта (Windows Desktop) и запуск анализа
- [x] Отобразить прогресс (стадии/счётчики файлов), итоговый JSON, кнопки «Скопировать» и «Сохранить в файл»
- [x] Встроить агента в существующую архитектуру настроек (использовать `AppSettings` при необходимости)
- [x] UI‑представление: показывать только файлы с проблемами; скрывать пустой блок; очищать вывод при выборе нового проекта
- [ ] Добавить маршрутизацию и элемент в меню/навигации

## Этап 6. Тесты и качество
- [ ] Юнит-тесты для модулей парсинга зависимостей (pubspec/package.json/gradle)
- [ ] Юнит-тесты эвристик читаемости/безопасности
- [ ] Виджет-тесты UI (`CodeAuditScreen`) на запуск и отображение результата
- [ ] Производительные тесты на больших директориях (с мок-структурами)

## Этап 7. Документация и поддержка
- [ ] Обновить `README.md` (root) разделом про нового агента и экран
- [ ] Обновить/добавить документ `docs/code_audit_agent.md` с описанием критериев анализа, ограничений, формата JSON
- [ ] Обновить `roadmaps/ROADMAP.md` (или профильный раздел) — отметить создание/интеграцию агента
- [ ] Добавить примеры использования и скриншоты UI

## Этап 8. Расширения (после MVP)
- [ ] Глубокая проверка зависимостей с сетью (проверка актуальности/уязвимостей) со switch в настройках
- [ ] Языковые плагины для анализаторов (Dart analyzer, ESLint/TS, Kotlin/Java parsers) с адаптерами
- [ ] Интеграция с MCP для внешних линтеров/сканеров
- [ ] Генерация автофиксов (дифф/патчи) на основе найденных проблем
