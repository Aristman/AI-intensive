# Архитектура Telegram HTTP MCP Server

## Обзор архитектуры

Telegram HTTP MCP Server представляет собой REST API сервер, построенный на принципах модульной архитектуры с четким
разделением ответственности. Сервер реализует Model Context Protocol (MCP) для взаимодействия с Telegram API через HTTP
интерфейс.

## Компоненты системы

### 1. HTTP Сервер (Express.js)

**Файл:** `server.js`  
**Назначение:** Обработка HTTP запросов и маршрутизация

**Ключевые возможности:**

- REST API эндпоинты (`/health`, `/tools`)
- JSON парсинг с лимитом размера (1MB)
- Логирование HTTP запросов через Morgan
- Глобальная обработка ошибок
- CORS поддержка (через Express middleware)

**Маршруты:**

- `GET /health` - проверка статуса сервера
- `POST /tools` - выполнение инструментов

### 2. Telegram Клиент (GramJS)

**Библиотека:** `telegram` (GramJS)  
**Назначение:** Низкоуровневое взаимодействие с Telegram API

**Особенности:**

- Асинхронная работа с Telegram MTProto API
- Управление сессиями через StringSession
- Автоматические переподключения (connectionRetries: 3)
- Имитация устройства (deviceModel, systemVersion, appVersion)

### 3. Менеджер сессий

**Функционал:**

- Загрузка сессии из файла (`session.txt`)
- Создание новой сессии при первом запуске
- Проверка валидности сессии
- Безопасное хранение сессионных данных

**Процесс аутентификации:**

1. Создание клиента с пустой сессией
2. Запрос номера телефона и кода подтверждения
3. Сохранение валидной сессии в файл
4. Повторное использование сессии при перезапусках

### 4. Инструменты (Tools)

Сервер предоставляет набор инструментов для взаимодействия с Telegram. Каждый инструмент реализован как отдельная
функция с унифицированным интерфейсом.

#### Структура инструмента:

```javascript
async function toolName(input = {}) {
  // Валидация входных данных
  // Получение клиента
  // Выполнение операции
  // Форматирование результата
  // Обработка ошибок
  return result;
}
```

#### Доступные инструменты:

**tg.resolve_chat**

- **Назначение:** Разрешение идентификатора чата
- **Вход:** `chat` (string) - username, ID или URL
- **Выход:** Объект с id, username, title, type
- **Особенности:** Поддержка различных форматов идентификаторов

**tg.fetch_history**

- **Назначение:** Получение истории сообщений
- **Вход:** `chat`, `limit`, `offset_id`, `min_id`, `max_id`
- **Выход:** Объект с массивом сообщений
- **Особенности:** Пагинация, фильтрация по дате/ID

**tg.send_message**

- **Назначение:** Отправка текстового сообщения
- **Вход:** `chat`, `message`
- **Выход:** Статус отправки и ID сообщения
- **Особенности:** Поддержка только текста (без медиа)

**tg.forward_message**

- **Назначение:** Пересылка сообщения между чатами
- **Вход:** `from_chat`, `to_chat`, `message_id`
- **Выход:** Статус операции
- **Особенности:** Сохранение контекста отправителя

**tg.read_messages**

- **Назначение:** Маркировка сообщений как прочитанные
- **Вход:** `chat`, `ids` или `max_id`
- **Выход:** Количество прочитанных сообщений
- **Особенности:** Поддержка как индивидуальных, так и массовых операций

**tg.get_unread_count**

- **Назначение:** Получение статистики непрочитанных сообщений
- **Вход:** `chat`
- **Выход:** Количество непрочитанных и упоминаний
- **Особенности:** Использование Telegram dialogs API

### 5. Обработка ошибок

**Уровни обработки:**

1. **Глобальный обработчик Express** - перехват необработанных ошибок
2. **Инструментный уровень** - try/catch в каждой функции
3. **API уровень** - стандартизированные HTTP коды ответов

**Типы ошибок:**

- `NEEDS_AUTH` (503) - требуется аутентификация
- `400` - некорректные параметры
- `500` - внутренние ошибки сервера

### 6. Логирование

**Компоненты:**

- **HTTP логирование:** Morgan с форматом 'combined'
- **Ошибка логирование:** console.error для исключений
- **Информационное логирование:** console.log для важных событий

**Формат логов:**

```
[HTTP] IP - - [DATE] "METHOD URL" STATUS SIZE "REFERER" "USER_AGENT"
[ERROR] Tool execution failed: message
[INFO] Server listening on HOST:PORT
```

## Поток данных

### Запрос → Ответ

```
HTTP Request
    ↓
Express Router (/tools)
    ↓
Tool Selection (switch statement)
    ↓
Input Validation & Normalization
    ↓
ensureClient() - Получение Telegram клиента
    ↓
Telegram API Call (GramJS)
    ↓
Response Formatting
    ↓
JSON Response
```

### Аутентификация

```
Start Auth Script
    ↓
Create TelegramClient with empty session
    ↓
client.start() with callbacks
    ↓
User Input (phone, code, password)
    ↓
Session String Generation
    ↓
Save to file (session.txt)
    ↓
Ready for server startup
```

## Безопасность

### Механизмы защиты:

1. **Отсутствие встроенной аутентификации** - ответственность на уровне инфраструктуры
2. **Валидация входных данных** - проверка типов и форматов
3. **Лимиты запросов** - ограничение размера JSON (1MB)
4. **Сессионная безопасность** - хранение сессии в защищенном файле
5. **Минимальные привилегии** - только необходимые Telegram разрешения

### Рекомендации:

- Использование HTTPS в продакшене
- Защита на уровне firewall
- Регулярное обновление зависимостей
- Мониторинг доступа к API

## Производительность

### Оптимизации:

1. **Ленивая инициализация клиента** - создание только при первом использовании
2. **Переиспользование сессии** - загрузка из файла вместо повторной аутентификации
3. **Асинхронная обработка** - неблокирующие операции с Telegram API
4. **Эффективное использование памяти** - минимальный набор зависимостей

### Ограничения:

- Одиночная сессия на сервер (один аккаунт)
- Последовательная обработка запросов (нет параллелизма)
- Зависимость от доступности Telegram API

## Расширяемость

### Добавление нового инструмента:

1. Реализовать функцию в `server.js`
2. Добавить case в switch statement `/tools`
3. Обновить документацию (README.md)
4. Добавить тесты (при наличии)

### Модификация архитектуры:

- **Многосессионность:** Добавление поддержки нескольких аккаунтов
- **Кэширование:** Внедрение Redis для кэширования результатов
- **WebSocket:** Замена HTTP на WebSocket для двусторонней связи
- **База данных:** Добавление персистентности для истории

## Мониторинг и отладка

### Метрики:

- Количество запросов по инструментам
- Время выполнения операций
- Коды ответов HTTP
- Ошибки аутентификации

### Отладка:

- Verbose логирование с переменной окружения
- Health check эндпоинт
- Подробные сообщения об ошибках
- Трассировка API вызовов

## Зависимости

### Runtime зависимости:

- `express` - HTTP сервер
- `telegram` - Telegram API клиент
- `dotenv` - конфигурация окружения
- `morgan` - HTTP логирование
- `input` - консольный ввод (только для auth)

### Dev зависимости:

- Отсутствуют (проект использует только runtime зависимости)

## Развертывание

Архитектура поддерживает различные сценарии развертывания:

### Локальная разработка:

- Прямой запуск через `npm start`
- Горячая перезагрузка (опционально через nodemon)

### Продакшн:

- SystemD сервис
- Docker контейнеры
- PM2 процесс менеджер
- Nginx реверс-прокси

### Облачные платформы:

- VPS с Node.js
- Docker в Kubernetes
- Serverless функции (с модификациями)

## Будущие улучшения

### Краткосрочные:

- Добавление поддержки медиа-файлов
- Реализация rate limiting
- Улучшение обработки ошибок

### Долгосрочные:

- Многоаккаунтная поддержка
- Кластеризация
- Интеграция с базами данных
- Webhook поддержка для входящих сообщений
