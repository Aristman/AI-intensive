# Telegram HTTP MCP Server

## Описание

Telegram HTTP MCP Server - это HTTP-сервер, реализующий протокол MCP (Model Context Protocol) для взаимодействия с
Telegram API. Сервер предоставляет инструменты для чтения, отправки и управления сообщениями в Telegram через REST API.

Сервер построен на Node.js с использованием Express.js для HTTP-обработки и GramJS для взаимодействия с Telegram API. Он
поддерживает аутентификацию через сессии и предоставляет безопасный доступ к Telegram функциям.

## Возможности

- **Разрешение чатов**: Получение информации о чате по имени, ID или username
- **Чтение истории**: Получение истории сообщений с пагинацией
- **Отправка сообщений**: Отправка текстовых сообщений в чаты
- **Пересылка сообщений**: Пересылка сообщений между чатами
- **Чтение сообщений**: Маркировка сообщений как прочитанных
- **Количество непрочитанных**: Получение количества непрочитанных сообщений

## Переменные окружения

| Переменная        | Описание                                             | Значение по умолчанию |
|-------------------|------------------------------------------------------|-----------------------|
| `PORT`            | Порт, на котором запускается сервер                  | `3000`                |
| `HOST`            | Хост для привязки сервера                            | `0.0.0.0`             |
| `TG_APP_ID`       | ID приложения Telegram (получить на my.telegram.org) | Обязательно           |
| `TG_API_HASH`     | API Hash приложения Telegram                         | Обязательно           |
| `TG_SESSION_FILE` | Путь к файлу сессии Telegram                         | `./session.txt`       |

## Инструменты

### tg.resolve_chat

Разрешает чат по имени, ID или username.

**Параметры:**

- `input` или `chat`: Идентификатор чата (username, ID, URL)

**Пример запроса:**

```json
{
  "tool": "tg.resolve_chat",
  "input": {
    "chat": "@username"
  }
}
```

**Пример ответа:**

```json
{
  "id": "123456789",
  "username": "username",
  "title": "Название чата",
  "type": "user"
}
```

### tg.fetch_history

Получает историю сообщений из чата.

**Параметры:**

- `chat`: Идентификатор чата
- `limit`: Количество сообщений (по умолчанию 50)
- `offset_id`: ID сообщения для смещения
- `min_id`: Минимальный ID сообщения
- `max_id`: Максимальный ID сообщения

**Пример запроса:**

```json
{
  "tool": "tg.fetch_history",
  "input": {
    "chat": "@username",
    "limit": 10
  }
}
```

**Пример ответа:**

```json
{
  "chat": "@username",
  "messages": [
    {
      "id": 123,
      "text": "Привет!",
      "date": "2023-10-01T12:00:00.000Z",
      "from": {
        "id": "987654321",
        "display": "Имя Пользователя"
      }
    }
  ]
}
```

### tg.send_message

Отправляет текстовое сообщение в чат.

**Параметры:**

- `chat`: Идентификатор чата
- `message`: Текст сообщения

**Пример запроса:**

```json
{
  "tool": "tg.send_message",
  "input": {
    "chat": "@username",
    "message": "Привет от MCP сервера!"
  }
}
```

**Пример ответа:**

```json
{
  "ok": true,
  "id": 456
}
```

### tg.forward_message

Пересылает сообщение из одного чата в другой.

**Параметры:**

- `from_chat`: Исходный чат
- `to_chat`: Целевой чат
- `message_id`: ID сообщения для пересылки

**Пример запроса:**

```json
{
  "tool": "tg.forward_message",
  "input": {
    "from_chat": "@source",
    "to_chat": "@target",
    "message_id": 123
  }
}
```

**Пример ответа:**

```json
{
  "ok": true
}
```

### tg.read_messages

Маркирует сообщения как прочитанные.

**Параметры:**

- `chat`: Идентификатор чата
- `ids`: Массив ID сообщений (опционально)
- `max_id`: Максимальный ID для чтения (опционально)

**Пример запроса:**

```json
{
  "tool": "tg.read_messages",
  "input": {
    "chat": "@username",
    "ids": [
      123,
      124,
      125
    ]
  }
}
```

**Пример ответа:**

```json
{
  "ok": true,
  "count": 3
}
```

### tg.get_unread_count

Получает количество непрочитанных сообщений в чате.

**Параметры:**

- `chat`: Идентификатор чата

**Пример запроса:**

```json
{
  "tool": "tg.get_unread_count",
  "input": {
    "chat": "@username"
  }
}
```

**Пример ответа:**

```json
{
  "chat": "@username",
  "unread": 5,
  "unread_mentions": 2
}
```

## API Endpoints

### GET /health

Проверяет статус сервера и подключения к Telegram.

**Ответы:**

- `200`: `{"ok": true, "status": "ready"}`
- `503`: `{"ok": false, "error": "needs_auth"}` - требуется аутентификация
- `500`: `{"ok": false, "error": "..."}` - ошибка

### POST /tools

Выполняет инструмент.

**Тело запроса:**

```json
{
  "tool": "имя_инструмента",
  "input": {
    /* параметры */
  }
}
```

## Аутентификация

Перед запуском сервера необходимо выполнить аутентификацию в Telegram:

1. Создать приложение на [my.telegram.org](https://my.telegram.org)
2. Получить `api_id` и `api_hash`
3. Установить переменные окружения `TG_APP_ID` и `TG_API_HASH`
4. Запустить `npm run auth` для входа в аккаунт
5. Следовать инструкциям в консоли для ввода номера телефона и кода подтверждения

После успешной аутентификации сессия сохраняется в файл `session.txt` и может быть использована повторно.

## Безопасность

- Сервер не имеет встроенной аутентификации - защищайте доступ к нему на уровне сети
- Переменные окружения с чувствительными данными не должны попадать в логи
- Рекомендуется использовать HTTPS в продакшене
- Сессия Telegram хранится локально и должна быть защищена

## Зависимости

- `express`: Веб-фреймворк
- `telegram`: GramJS клиент для Telegram API
- `dotenv`: Загрузка переменных окружения
- `morgan`: Логирование HTTP запросов
- `input`: Чтение ввода из консоли

## Логирование

Сервер использует Morgan для логирования HTTP запросов в формате Combined. Дополнительные логи ошибок выводятся в
stderr.
