# План: AutoFix Agent (агент автоисправления кода)

Обновлено: 2025-08-26
Статус: Draft (этап 1)
Ответственные: TBD

## 1) Цели и границы
- Автоматизировать анализ и исправление кода в переданном файле или папке.
- Показать пользователю дифф изменений (– удалено, + добавлено) до применения.
- Вносить правки в те же файлы только после явного подтверждения пользователя.
- Переиспользовать наработки CodeOps: единый интерфейс агента, стриминг событий, LLM‑резолвер, MCP.

Вне рамок этапа 1: глубокий рефакторинг по проекту, автокоммит в VCS, сложные миграции.

## 2) Высокоуровневый сценарий (UX)
1. Пользователь открывает новую вкладку AutoFix в приложении.
2. Выбирает: одиночный файл или директорию проекта.
3. Жмёт «Проанализировать». Агент запускает анализ: статические проверки, попытка сборки/линтинга (если применимо), LLM‑оценка.
4. Агент генерирует список проблем и предлагает исправления в виде унифицированных патчей.
5. UI показывает сводку и интерактивный дифф (–/+). Пользователь может:
   - Принять все изменения;
   - Снять/поставить галочки на отдельных файлах;
   - Отклонить.
   Примечание: предпросмотр и выбор по отдельным хуникам будет реализован позже как отдельная задача (М4).
6. После подтверждения — изменения записываются в соответствующие файлы. Логи и результат доступны в истории.

## 3) Архитектура и переиспользование
- Базироваться на унифицированном интерфейсе агентов: `sample_app/lib/agents/agent_interface.dart` (IAgent, AgentRequest/Response, IStatefulAgent и т.д.).
- Новый агент: `AutoFixAgent` (папка `sample_app/lib/agents/auto_fix/`).
- Новый экран: `AutoFixScreen` (папка `sample_app/lib/screens/`). Регистрация в навигации и вкладках (`home_screen.dart`/`multi_agents_screen.dart`).
- Резолвер LLM: общий `resolveLlmUseCase(AppSettings)` из `sample_app/lib/domain/llm_resolver.dart`.
- Стриминг событий: использовать подход CodeOpsBuilderAgent (события прогресса, контекст runId).
 - MCP: отложить до М3; MVP (М1–М2) работает локально в приложении без MCP. Интеграция для линтинга/сборок добавится на М3.

## 4) Протокол взаимодействия агента
Стадии и события (через стриминг):
- `analysis_started` {path, mode: file|dir}
- `analysis_progress` {file, hints}
- `analysis_complete` {issues: [...], metrics}
- `fix_suggestions_generated` {patches: [{filePath, diffUnified, hunks:[...]}]}
- `awaiting_user_approval` {summary}
- `apply_started` {selectedFiles}
- `apply_result` {applied:[...], skipped:[...], errors:[...]}
- `pipeline_complete` {success, stats}

Типы данных:
- Issue: {filePath, line?, column?, severity, rule?, message}
- Patch: Unified Diff (git‑style) или наш формат V4A (для внутренних операций) + рендерер в UI. Для отображения — стандартный unified‑diff.

## 5) Анализатор (минимально жизнеспособный)
- Одиночный файл: эвристический разбор по расширению (Dart/JS/TS/Kotlin/Java/MD). Выполнить:
  - Базовый синтакс‑чек (где возможно);
  - Локальные линты (если доступно); 
  - LLM‑оценка содержимого: потенциальные ошибки, неиспользуемые импорты, очевидные баги, форматирование блоков.
  Примечание: MVP языки — Dart, Markdown, Java, Kotlin. JS/TS можно добавить на более позднем этапе.
- Директория: рекурсивный сбор файлов по маскам; ограничение по количеству/размеру; пакетная агрегация проблем; опционально — попытка `flutter analyze`/`gradle build -x test` через MCP (позже, отдельная фича).

Вывод анализатора — список Issues + предложения правок (patch proposals), агрегированных для UI.

## 6) Генерация исправлений
- LLM формирует патчи как unified diff для каждого файла.
- Валидация патчей:
  - Применимость (патч соответствует текущему содержимому);
  - Отсутствие конфликтов между патчами;
  - Безопасная область (не менять бинарники/large files).
- При расхождении контента — запрос перегенерации/ребейза патча.

## 7) Отображение диффа и подтверждение
 - Компонент дифф‑просмотра в `AutoFixScreen`: подсветка –/+, навигация по файлам, чекбоксы по файлам.
   Предпросмотр и выбор по хуникам — отдельная задача (М4) после завершения основной функциональности.
- Кнопки: «Применить выбранное», «Отклонить всё», «Перегенерировать».
- После подтверждения — запись изменений в файлы.

## 8) Применение изменений
- Преобразовать unified diff в патчи и применить к исходным файлам.
- Защититься от гонок: проверять hash/mtime перед записью, при изменении — переспрос/перегенерация.
- Логировать итоги, возвращать список применённых/пропущенных правок.

## 9) Интеграции и настройки
- Настройки приложения (`AppSettings`): лимиты размера, включение MCP, URL MCP.
- Повторное использование CodeOps событий и утилит.
- Права доступа к файловой системе в UI (для выбора папки/файлов) — применить существующие паттерны из экрана CodeOps.

## 10) Тест‑план
- Юнит‑тесты:
  - Парсинг Issues и преобразование предложений в unified diff.
  - Валидация и применение патчей (success/конфликт/несоответствие контенту).
  - Последовательность событий стриминга и наличие runId.
- Виджет‑тесты:
  - Рендер диффа (–/+), выбор файлов, подтверждение.
  - Поведение при отключённом MCP.
- Интеграционные (позднее):
  - Анализ небольшой директории Dart/Flutter, применение фиксов и `flutter analyze` без ошибок.

## 11) UX и доступность
- Плавные состояния загрузки, отмена анализа.
- Подсветка синтаксиса в диффе (минимально — цвета –/+).
- Сообщения об ошибках с советами (например, «патч устарел» → «обновить анализ»).

## 12) Риски и смягчение
- Качество патчей LLM: добавить валидацию и частичное применение (по хункам).
- Большие проекты: лимиты по размеру и выборочная выборка файлов.
- Конфликты при записи: проверка mtime/hash и повторный цикл анализа.

## 13) Вехи (MVP → расширение)
- М1 (этот PR): план (файл), TODO, каркас агента и экрана (скелет, без логики), навигация.
- М2: базовый анализ одиночного файла, генерация и рендер диффа, применение после подтверждения.
 - М3: поддержка директорий, батч‑анализ, интеграция MCP/локальных инструментов (линтеры/сборки), тесты (юнит/виджет), документация.
 - М4: предпросмотр по хуникам (выбор/навигация по хункам), расширенная валидация патчей, телеметрия.

## 14) Deliverables этапа 1
- Этот файл плана: `docs/auto_fix_agent_plan.md`.
- Обновлённый TODO (в трекере задач инструмента разработки).

## 15) Ссылки на смежные части проекта
- Интерфейс агентов: `sample_app/lib/agents/agent_interface.dart`
- Резолвер LLM: `sample_app/lib/domain/llm_resolver.dart`
- Экран CodeOps (паттерны UI/событий): `sample_app/lib/screens/code_ops_screen.dart`
- MCP клиент: `sample_app/lib/services/mcp_client.dart`
- Настройки: `sample_app/lib/data/app_settings.dart` (и связанные экраны)
