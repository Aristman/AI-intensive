# Промпт для нейросети (Python версия)

**Роль:** Ты — опытный Python разработчик, специализирующийся на асинхронном программировании и создании серверов Model Context Protocol (MCP). Ты также имеешь опыт работы с Telegram API через библиотеку Telethon.

**Задача:** Создать с нуля MCP-сервер для работы с Telegram на современном Python (3.10+), строго следуя предоставленному техническому заданию и архитектуре.

**Расположение** проект создай в папке `telegram_stdio_mcp_server/python`

**Техническое задание (ТЗ):**

Сервер должен реализовывать следующий функционал Telegram API:
1.  **Разрешение чатов:** Получение информации о чате по имени, ID или username.
2.  **Чтение истории:** Получение истории сообщений с поддержкой пагинации (лимит, смещение).
3.  **Отправка сообщений:** Отправка текстовых сообщений в указанные чаты.
4.  **Пересылка сообщений:** Пересылка сообщений между чатами.
5.  **Чтение сообщений:** Маркировка одного или нескольких сообщений как прочитанных.
6.  **Количество непрочитанных:** Получение общего количества непрочитанных сообщений.

**Архитектура и структура проекта:**
```
project-root/
├── src/
│   ├── __init__.py
│   ├── main.py          # Точка входа, инициализация сервера
│   ├── handlers/
│   │   ├── __init__.py
│   │   ├── resources.py # Менеджер ресурсов (list/read)
│   │   └── tools.py     # Менеджер инструментов (list/call)
│   ├── config.py        # Конфигурация сервера
│   └── utils.py         # Вспомогательные утилиты
├── requirements.txt
└── README.md
```

**Детальные инструкции по файлам:**

1.  **`src/config.py`:**
    *   Создай конфигурацию с использованием переменных окружения (os.getenv).
    *   Экспортируй настройки: `NAME` (например, "telegram-mcp-server"), `VERSION` (например, "0.1.0"), а также `API_ID`, `API_HASH`, `PHONE_NUMBER` для Telegram.
    *   Если какая-либо из критических переменных окружения отсутствует, логируй ошибку и завершай работу.

2.  **`src/utils.py`:**
    *   Создай асинхронные вспомогательные функции.
    *   `setup_telegram_client`: Асинхронная функция для инициализации и аутентификации клиента Telethon. Обрабатывай 2FA.
    *   `get_input_entity`: Асинхронная функция, которая принимает идентификатор чата (число, строку с юзернеймом или телефоном) и возвращает соответствующий объект `InputPeer`.
    *   Добавь функцию для логирования ошибок `log_error(error)`, которая выводит подробности в `sys.stderr`.

3.  **`src/handlers/resources.py`:**
    *   Реализуй асинхронные функции `list_resources` и `read_resource` в соответствии с MCP протоколом.
    *   `list_resources`: Пока возвращает пустой список или список с ресурсами-плейсхолдерами.
    *   `read_resource`: Принимает URI и возвращает содержимое. Пока можно возвращать ошибку "Resource not found".

4.  **`src/handlers/tools.py`:**
    *   Реализуй асинхронную функцию `list_tools`, которая возвращает список инструментов с их схемами (в формате JSON Schema) для каждого из 6 пунктов ТЗ.
    *   Реализуй асинхронную функцию `call_tool`, которая обрабатывает вызов инструмента по имени.
        *   Используй `if`/`elif` для маршрутизации вызовов по имени инструмента.
        *   Вызывай соответствующие асинхронные функции для взаимодействия с Telegram API (используя Telethon).
        *   Тщательно обрабатывай ошибки с помощью `try/except`, логируй их и возвращай сообщение об ошибке.

5.  **`src/main.py`:**
    *   Импортируй необходимые модули: `mcp` (или конкретные классы из него), а также созданные обработчики и утилиты.
    *   Создай экземпляр сервера MCP.
    *   Зарегистрируй обработчики ресурсов и инструментов.
    *   Инициализируй сервер с STDIO транспортом.
    *   Реализуй корректную обработку сигналов для graceful shutdown.

**Общие требования к коду:**
*   **Стиль:** Используй современный Python (3.10+) с асинхронным кодом (async/await).
*   **Зависимости:** Укажи в `requirements.txt` следующие зависимости: `mcp`, `telethon`, и, возможно, `python-dotenv` для загрузки переменных окружения.
*   **Комментарии:** Добавь четкие `# TODO:` комментарии в тех местах, где требуется доработка или реализация сложной логики.
*   **Логирование:** Все ошибки и отладочная информация (кроме результата работы инструментов) должны выводиться в `stderr` через `logging` или `print(..., file=sys.stderr)`.
*   **Заглушки:** Если реализация какой-то части требует длительной разработки, сначала создай работающую заглушку, чтобы сервер запускался, и пометь ее `TODO`-комментарием.

**Начало работы:**
Перед генерацией кода создай в корне проекта файл `Roadmap.md` и запиши в него подробный пошаговый план на основе этого ТЗ и промпта. В процессе работы отмечай выполненные шаги.

---

**Начни выполнение задачи.** Сгенерируй полный исходный код для каждого из указанных файлов, строго следуя инструкциям.