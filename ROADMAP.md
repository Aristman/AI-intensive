# План доработок проекта AI-intensive
Создай класс java с двумя методами. Первый возвращает произведение двух входных параметров. Второй выводит строку "Результат " с переданным числом. Покрой этот класс тестами
Документ объединяет стратегию развития всех подсистем репозитория и служит "точкой входа" для планирования.

## Общие (root проекта)
- [ ] CI/CD: GitHub Actions для сборки `issue-monitor` (fat-jar), линтинга и прогонов тестов
- [ ] Единый шаблон `.env.example`/`config.properties.sample` и инструкция по секретам
- [ ] Версионирование релизов (tags, changelog) и релиз артефактов (jar, docker image)
- [ ] Улучшить документацию: обзор архитектуры (MCP ↔ apps), схемы обмена, частые ошибки
  - [x] Обновлены README (root, `sample_app/README.md`) и `docs/github_agent_screen_plan.md`: добавлены примеры JSON‑RPC (initialize, tools/list, tools/call), актуализирован список MCP‑инструментов (удалён `list_issues`), описан локальный диалог настроек GitHubAgentScreen и тестовые ключи
 - [x] Унифицированный интерфейс агентов (IAgent, IStatefulAgent, IToolingAgent, DTOs и утилиты),
       добавлены юнит-тесты; документация: `docs/agent_interface.md`

## mcp_server/
- [ ] Dockerfile + docker-compose (node:lts-alpine, healthcheck)
- [x] Логи в JSON-формате, корректные коды ошибок JSON-RPC, расширенная диагностика
  - Включено структурированное JSON‑логирование (с `traceId`, `durationMs`, типами событий)
  - Реализованы корректные коды ошибок JSON‑RPC: `-32700`, `-32600`, `-32601`, `-32602`, `-32603` + серверные `-3200x`
  - Расширена диагностика GitHub/Telegram API и Docker (`ghRequest`, `tgRequest`, `docker_*`) с кодами `-32010/-32011/-32020/-32021`
 - [x] Документация новых GitHub инструментов (релизы и PR) в `mcp_server/README.md` с JSON-RPC примерами
 - [ ] Unit-тесты для GitHub инструментов: `create_release`, `list_pull_requests`, `get_pull_request`, `list_pr_files` (моки GitHub API)
 - [ ] Rate limiting и простая аутентификация (например, `X-API-Key` через ревёрс-прокси)
- [ ] Интеграционные тесты инструментов (`get_repo`, `search_repos`, `create_issue`) с моками GitHub API
- [ ] Безопасность: валидация входных параметров, защита от слишком частых запросов

- [x] Инструмент выполнения Java-кода в контейнере (`docker_exec_java`)
  - Вход: `filename`, `entrypoint` (main class), `classpath`, доп. флаги
  - Передача кода: volume-монтаж; рабочая директория и политика очистки
  - Выход: stdout/stderr, код возврата, длительность; структурированный JSON
  - Таймаут выполнения, лимиты ресурсов контейнера
  - [x] Поддержка JUnit4: авто-обнаружение импортов (`org.junit.*`), автоматическая загрузка `junit-4.13.2.jar` и `hamcrest-core-1.3.jar`, запуск через `JUnitCore` с корректным classpath
  - [x] Обновлён образ по умолчанию на `eclipse-temurin:20-jdk` (соответствует `jvmToolchain(20)` в root)
- [ ] Улучшить `docker_start_java`: диагностика демона/порта, ретраи, понятные сообщения об ошибках
- [ ] Безопасность Docker-инструментов: запрет опасных флагов в `extra_args`, whitelisting параметров

## issue-monitor/
- [ ] Добавить Docker/systemd unit под среду Linux (для issue-monitor)
  - Dockerfile (eclipse-temurin:17-jre-alpine, non-root user, tini)
  - docker-compose с зависимостью от `mcp_server`
  - systemd unit c переменной `CONFIG_FILE`, авто‑рестартом и журналированием
- [ ] Health‑check (встроенный HTTP `/health` или периодический лог‑пульс)
- [ ] Ретраи и backoff при сбоях MCP/сети, авто‑reconnect WebSocket
- [ ] Структурированные логи (ключевые поля: repo, count, mcpUrl, error)
- [ ] Метрики (опционально Prometheus: количество уведомлений, ошибки, длительность)
- [ ] Конфиг‑reload без рестарта (перечитывание файла по сигналу/таймеру)
- [ ] Тесты: unit (формирование сообщения/парсинг ответа), интеграционные (локальный тестовый MCP)

## sample_app/
- [x] Централизация навигации через enum `Screen` (SSOT: иконки, лейблы, пункты нижней навигации и фабрика страниц в `screens.dart`)
- [x] Централизованный резолвер LLM (`resolveLlmUseCase`) и рефакторинг агентов; добавлены юнит‑тесты; обновлена документация (README/ROADMAP)
 - [ ] Интеграция `McpGithubService` в `GitHubAgentScreen` (создание релиза, управление PR) и покрытие виджет/юнит‑тестами
   - [x] Убран ввод owner/repo из основного UI; добавлен локальный диалог настроек с валидацией и персистентностью
   - [x] Ключи для тестов диалога: `github_local_owner_field`, `github_local_repo_field`, `github_local_repos_limit_field`, `github_local_issues_limit_field`, `github_local_other_limit_field`, `github_local_save_btn`; кнопка `github_local_settings_btn`; лейбл контекста `github_repo_context_label`
   - [x] Поле запроса активно всегда; MCP вызовы берут owner/repo из настроек при отсутствии явного ввода
   - [x] Промпт `ReasoningAgent.extraSystemPrompt` включает текущие owner/repo и описание доступных MCP инструментов (без `list_issues`)
   - [x] Виджет‑тесты: открытие/сохранение диалога, применение настроек, влияние лимитов в `_summarizeToolResult`, поведение MCP при отсутствии инструмента (`-32601`)
   - [x] Документация обновлена: root `README.md` и `sample_app/README.md` — раздел про GitHubAgentScreen, ключи и лимиты
   - [ ] Интеграционные тесты MCP для `create_issue` (успех и ошибка)
   - [ ] UX: кликабельные ссылки в итогах (issue/release/PR URL) на экране GitHubAgent
   - [ ] Verbose‑логирование MCP: настройка в Settings и документация, где смотреть логи (dev.log)
   - [ ] Улучшения мок‑клиента MCP: кэш `tools/list` по URL, preflight‑проверки доступности инструментов
   - [ ] Предупреждение в UI при отключённом MCP (tooltip/snackbar) и покрытие тестами
- [x] AutoFix (MVP): базовый агент и экран `AutoFix`
  - [x] Стриминг событий: `pipeline_start` → `analysis_started` → `analysis_result` (warning при пустом пути/нет файлов) → `pipeline_complete`
  - [x] Базовые фиксы: удаление хвостовых пробелов, добавление финальной новой строки
  - [x] Unified diff предпросмотр; применение патчей и `rollback` через `PatchApplyService` (создание `.bak`)
  - [x] Виджет‑смоук тест экрана: `test/screens/auto_fix_screen_smoke_test.dart`
  - [x] Документация: `README.md` (root) и `sample_app/README.md` — раздел AutoFix (MVP)
- [ ] AutoFix (M2)
  - [ ] Интеграция LLM для анализа и генерации патчей (Dart/Markdown/Java/Kotlin)
  - [x] LLM‑hook: агент формирует запрос к LLM и стримит `analysis_result` с `meta.llm_raw`; экран добавлен переключатель LLM и отображение предложений; юнит‑тесты добавлены
  - [ ] Улучшение UI diff: подсветка синтаксиса, цветовые маркеры +/- , сворачивание блоков
  - [ ] Валидация применимости патча и детекция конфликтов перед применением
  - [ ] Расширить тесты: парсинг/применение/rollback патчей; негативные кейсы; UI‑поведение
  - [ ] Пакетный анализ директорий, прогресс и отчёт по нескольким файлам
  - [ ] Поддержка дополнительных форматов (gradle, json, yaml) с безопасными правилами
  - [ ] Неблокирующая обработка и отмена пайплайна (API отмены + корректные финальные события)
  - [ ] Улучшение DX: ключи для тестов, стабильные таймеры ожидания в виджет‑тестах
- [ ] Настроить работу экрана CodeOps с LLM YandexGPT (приоритет: первый)
  - [ ] Интегрировать `YandexGptUseCase` в `CodeOpsAgent`/`CodeOpsBuilderAgent` через интерфейс `LlmUseCase`
  - [ ] Обновить выбор сети в настройках: добавить/актуализировать `NeuralNetwork.yandexgpt` для CodeOps
  - [x] Проверить совместимость формата сообщений/ответов (JSON с `files`/`tests`) в пайплайне генерация → тесты → запуск
  - [ ] Конфигурация окружения: `YANDEX_IAM_TOKEN`/`YANDEX_FOLDER_ID` (предпочтительно), временный fallback `YANDEX_API_KEY`
  - [ ] Проверить заголовки запросов:
    - IAM: `Authorization: Bearer <IAM_TOKEN>`; `folderId` только в `modelUri` (без `x-folder-id`)
    - Api-Key (временный fallback): `Authorization: Api-Key <API_KEY>` + `x-folder-id: <FOLDER_ID>`
  - [ ] Проверить эндпоинт `/completion` и корректность `modelUri`
  - [ ] Юнит/интеграционные тесты: успешный сценарий и негативные кейсы (таймаут/ошибка ответа)
  - [x] Обновить документацию: `sample_app/README.md` (секция YandexGPT + привязка к CodeOps)
- [ ] Оптимизировать страницу настроек
  - Упростить UX: единый блок MCP (URL, проверка подключения), явная индикация статуса
  - Валидация ввода (URL, пустые поля), подсказки и описание сценариев
  - Сохранение/применение настроек без перезапуска, аккуратные Snackbar/Dialogs об ошибках
  - Адаптивность и читабельность (мобильный/десктоп), i18n строк
- [ ] Рефакторинг зависимостей настроек (Provider/ChangeNotifier): мемоизация, разбиение на виджеты
- [ ] Покрытие UI‑тестами критических сценариев (проверка MCP и создание issue)
- [ ] YandexGPT: удалить доступ по Api-Key (оставить только IAM)
  - [ ] Перевести окружения на IAM токен (Bearer) + `x-folder-id`
  - [ ] Удалить fallback Api-Key из `sample_app/lib/data/llm/yandexgpt_usecase.dart`
  - [ ] Обновить `sample_app/README.md` (убрать fallback) и пример `assets/.env`
  - [ ] Анонсировать breaking change в релизных заметках (при наличии)
- [x] CodeOps: выполнение кода через Docker (первичная интеграция)
  - [x] Кнопка/подтверждение запуска для JSON‑генерации/вставленного кода
  - [x] Отображение stdout/stderr и кодов возврата; базовый таймаут
  - [x] Применена JSON‑схема запуска (filename, entrypoint)
  - [x] Автоопределение entrypoint/filename из Java‑кода (public class, package → FQCN и путь файла)
  - [x] Поддержка многофайловой Java‑генерации и запуска через MCP (каждый класс — отдельный файл, полные импорты)
  - [x] Обновление UI CodeOps для парсинга массива файлов, предпросмотра и запуска через `execJavaFilesInDocker()`
  - [x] Уточнение языка перед генерацией (UX): явное подтверждение языка пользователем, запуск поддержан только для Java
  - [x] Две кнопки на карточке: «Запуск кода» (одиночный файл) и «Запустить тест» (JUnit с минимальными зависимостями)
  - [x] Логика «Запуск кода»: отправляется только файл текущей карточки, без остальных
  - [x] Логика «Запустить тест»: отправляется тестовый файл + парный исходник `<Name>.java` (если найден), entrypoint = FQCN теста
  - [x] Вынесены утилиты парсинга Java (package/class/FQCN, детекция тестов) в `sample_app/lib/utils/code_utils.dart` и покрыты unit‑тестами
  - [ ] Улучшить UX отмены/повтора: индикатор прогресса; улучшенная обработка таймаута (follow‑up)
  - [ ] Кнопка отмены пайплайна в UI `CodeOpsScreen` (остановка текущего `runId`)
  - [ ] Поддержка отмены в агенте (`IAgent.cancel(runId)`/`cancelAll`) и корректные завершающие события (`pipeline_error` с `errorCode: "cancelled"`)
  - [ ] UI‑тесты CodeOpsScreen
    - [ ] Многофайловый предпросмотр и подтверждение запуска
    - [ ] Уточнение языка (Java only); запрет запуска для иных языков
    - [ ] Фоллбек на одиночный файл для legacy‑ответов
  - [x] Индикатор статуса MCP в AppBar (CodeOpsScreen)
    - [x] Постоянная видимость, статусы: MCP off/ready/active; тултип с URL/сообщением
    - [x] Виджет‑тесты состояний MCP off/ready
    - [ ] Тест состояния MCP active и таймера сброса активности
  - [ ] Надёжность/ошибки (CodeOps)
    - [ ] Обработка ошибок Docker/сети с дружелюбными сообщениями
    - [ ] Предварительная проверка доступности MCP/Docker перед запуском
    - [ ] Ретраи/повтор вызова MCP при временных сбоях
    - [ ] Улучшенные сообщения в UI (коды ошибок, подсказки, next steps)
    - [ ] Структурированные логи и trace id для корреляции
  - [ ] Расширенные параметры (classpath, args) из UI (опционально)
  - [ ] UI‑конфигурация Docker параметров: `image`, `container_name`, `limits`, `timeout`
  - [ ] E2E‑тест потока CodeOps: генерация → подтверждение → запуск в Docker → отображение результата (smoke‑тест)

- [x] Новый агент‑оркестратор CodeOpsBuilderAgent
  - Реализует унифицированный интерфейс `IAgent`/`IToolingAgent`, композиционно использует `CodeOpsAgent`
  - Поток: генерация классов → вопрос о создании тестов → JUnit4 тесты → запуск в Docker → анализ → рефайн тестов
  - Добавлена документация: `docs/code_ops_builder_agent.md`
  - Добавлены юнит‑тесты: `sample_app/test/code_ops_builder_agent_test.dart`
  - [x] Стриминг для CodeOpsBuilderAgent
    - Реализован `start()` со `Stream<AgentEvent>` (прогресс шагов, этапы пайплайна, промежуточные сообщения)
    - Интегрирован стрим в UI `sample_app/lib/screens/code_ops_screen.dart`:
      - индикатор прогресса пайплайна
      - отображение текущего шага и live‑лог событий
      - диалог подтверждения создания тестов (да/нет) в рамках потокового сценария
    - TODO: поддержка отмены пайплайна (API отмены и корректное завершение стрима)
    - Покрытие тестами:
      - добавлены unit‑тесты для новых DTO (`AgentEvent`, `AgentStage`, `AgentSeverity`)
      - обновлены тесты `CodeOpsBuilderAgent` (включен флаг streaming)
    - [x] Завершение пайплайна после тестов: `pipeline_complete` эмитится только после генерации и прогона тестов (или при отказе пользователя), а не сразу после `code_generated`
    - [x] Мульти‑ходовая континуация в стриминге: `start()` корректно подхватывает короткий ответ с языком (например, «Java») и продолжает генерацию, используя сохранённый промпт
      - интеграционные smoke‑тесты стрима — TODO (планируются отдельно)
    - [x] Двухфазные подтверждения: двойное `ask_create_tests` с `meta.action = 'create_tests'` и `meta.action = 'run_tests'`; подтверждения отправляются через повторный потоковый вызов `start()`
    - [x] Метаданные тестов в стриме: события `test_generated` содержат `meta.language` и список `meta.tests` для визуализации в UI
    - [x] Нормализация ключей результатов тестов (MCP camelCase ↔ агент snake_case): поддержка `exit_code`/`exitCode`, `stdout`/`stderr`; добавлены юнит‑тесты на camelCase (успех/провал)
    - [x] События Docker‑старта/результата: `docker_exec_started` и `docker_exec_result`; по одному результату на тест, повтор после рефайна помечается `refined: true`; все события содержат `runId`
    - [x] Fallback выполнения Docker: при выключенном MCP или пустом `mcpServerUrl` делегирование во внутренний `CodeOpsAgent`; при включённом MCP используется локальный MCP‑клиент; единая точка `_execJavaFilesWithFallback(...)`
    - [x] Обновление документации: актуализированы `docs/code_ops_builder_agent.md`, `sample_app/README.md`, `README.md` (события Docker и fallback)

  ### Вопросы для уточнения (CodeOps)
  - Начать с UI‑тестов `CodeOpsScreen` и небольшого рефакторинга (DI) для мокирования `CodeOpsAgent`?
  - Вынести утилиты парсинга карточек/фенсов (`_decodeCodeCard`, `_stripCodeFencesGlobal`) в `lib/utils/` и покрыть юнит‑тестами?
  - Добавлять сейчас preflight‑проверки MCP/Docker (включён ли MCP, валиден ли URL, ping инструмента) и улучшенные сообщения об ошибках, или отложить?

## Деплой и эксплуатация
- [ ] Плейбуки для VPS: подготовка окружения (Node, JDK 17, systemd, Docker), развертывание
- [ ] Скрипты обновления (zero‑downtime перезапуск сервисов)
- [ ] Мониторинг и алерты (ошибки MCP, отсутствие уведомлений, рост open issues)

## Идеи на будущее
- [ ] Фильтрация/агрегация: уведомления по меткам (labels), по исполнителям, по SLA
- [ ] Расширение MCP: инструмент `list_issues` c фильтрами; `create_comment` для авто‑комментариев
- [ ] Мульти‑канальные уведомления: Slack/Webhook (в дополнение к Telegram)
