# План доработок проекта AI-intensive
Создай класс java с двумя методами. Первый возвращает произведение двух входных параметров. Второй выводит строку "Результат " с переданным числом. Покрой этот класс тестами
Документ объединяет стратегию развития всех подсистем репозитория и служит "точкой входа" для планирования.

## Общие (root проекта)
- [ ] CI/CD: GitHub Actions для сборки `issue-monitor` (fat-jar), линтинга и прогонов тестов
- [ ] Единый шаблон `.env.example`/`config.properties.sample` и инструкция по секретам
- [ ] Версионирование релизов (tags, changelog) и релиз артефактов (jar, docker image)
- [ ] Улучшить документацию: обзор архитектуры (MCP ↔ apps), схемы обмена, частые ошибки
 - [x] Унифицированный интерфейс агентов (IAgent, IStatefulAgent, IToolingAgent, DTOs и утилиты),
       добавлены юнит-тесты; документация: `docs/agent_interface.md`

## mcp_server/
- [ ] Dockerfile + docker-compose (node:lts-alpine, healthcheck)
- [x] Логи в JSON-формате, корректные коды ошибок JSON-RPC, расширенная диагностика
  - Включено структурированное JSON‑логирование (с `traceId`, `durationMs`, типами событий)
  - Реализованы корректные коды ошибок JSON‑RPC: `-32700`, `-32600`, `-32601`, `-32602`, `-32603` + серверные `-3200x`
  - Расширена диагностика GitHub/Telegram API и Docker (`ghRequest`, `tgRequest`, `docker_*`) с кодами `-32010/-32011/-32020/-32021`
- [ ] Rate limiting и простая аутентификация (например, `X-API-Key` через ревёрс-прокси)
- [ ] Интеграционные тесты инструментов (`get_repo`, `search_repos`, `create_issue`) с моками GitHub API
- [ ] Безопасность: валидация входных параметров, защита от слишком частых запросов

- [x] Инструмент выполнения Java-кода в контейнере (`docker_exec_java`)
  - Вход: `filename`, `entrypoint` (main class), `classpath`, доп. флаги
  - Передача кода: volume-монтаж; рабочая директория и политика очистки
  - Выход: stdout/stderr, код возврата, длительность; структурированный JSON
  - Таймаут выполнения, лимиты ресурсов контейнера
  - [x] Поддержка JUnit4: авто-обнаружение импортов (`org.junit.*`), автоматическая загрузка `junit-4.13.2.jar` и `hamcrest-core-1.3.jar`, запуск через `JUnitCore` с корректным classpath
  - [x] Обновлён образ по умолчанию на `eclipse-temurin:20-jdk` (соответствует `jvmToolchain(20)` в root)
- [ ] Улучшить `docker_start_java`: диагностика демона/порта, ретраи, понятные сообщения об ошибках
- [ ] Безопасность Docker-инструментов: запрет опасных флагов в `extra_args`, whitelisting параметров

## issue-monitor/
- [ ] Добавить Docker/systemd unit под среду Linux (для issue-monitor)
  - Dockerfile (eclipse-temurin:17-jre-alpine, non-root user, tini)
  - docker-compose с зависимостью от `mcp_server`
  - systemd unit c переменной `CONFIG_FILE`, авто‑рестартом и журналированием
- [ ] Health‑check (встроенный HTTP `/health` или периодический лог‑пульс)
- [ ] Ретраи и backoff при сбоях MCP/сети, авто‑reconnect WebSocket
- [ ] Структурированные логи (ключевые поля: repo, count, mcpUrl, error)
- [ ] Метрики (опционально Prometheus: количество уведомлений, ошибки, длительность)
- [ ] Конфиг‑reload без рестарта (перечитывание файла по сигналу/таймеру)
- [ ] Тесты: unit (формирование сообщения/парсинг ответа), интеграционные (локальный тестовый MCP)

## sample_app/
- [ ] Оптимизировать страницу настроек
  - Упростить UX: единый блок MCP (URL, проверка подключения), явная индикация статуса
  - Валидация ввода (URL, пустые поля), подсказки и описание сценариев
  - Кнопка быстрого теста (create_issue) — единый поток для локального GitHub и внешнего MCP
  - Сохранение/применение настроек без перезапуска, аккуратные Snackbar/Dialogs об ошибках
  - Адаптивность и читабельность (мобильный/десктоп), i18n строк
- [ ] Рефакторинг зависимостей настроек (Provider/ChangeNotifier): мемоизация, разбиение на виджеты
- [ ] Покрытие UI‑тестами критических сценариев (проверка MCP и создание issue)

- [x] CodeOps: выполнение кода через Docker (первичная интеграция)
  - [x] Кнопка/подтверждение запуска для JSON‑генерации/вставленного кода
  - [x] Отображение stdout/stderr и кодов возврата; базовый таймаут
  - [x] Применена JSON‑схема запуска (filename, entrypoint)
  - [x] Автоопределение entrypoint/filename из Java‑кода (public class, package → FQCN и путь файла)
  - [x] Поддержка многофайловой Java‑генерации и запуска через MCP (каждый класс — отдельный файл, полные импорты)
  - [x] Обновление UI CodeOps для парсинга массива файлов, предпросмотра и запуска через `execJavaFilesInDocker()`
  - [x] Уточнение языка перед генерацией (UX): явное подтверждение языка пользователем, запуск поддержан только для Java
  - [x] Две кнопки на карточке: «Запуск кода» (одиночный файл) и «Запустить тест» (JUnit с минимальными зависимостями)
  - [x] Логика «Запуск кода»: отправляется только файл текущей карточки, без остальных
  - [x] Логика «Запустить тест»: отправляется тестовый файл + парный исходник `<Name>.java` (если найден), entrypoint = FQCN теста
  - [x] Вынесены утилиты парсинга Java (package/class/FQCN, детекция тестов) в `sample_app/lib/utils/code_utils.dart` и покрыты unit‑тестами
  - [ ] Улучшить UX отмены/повтора: индикатор прогресса; улучшенная обработка таймаута (follow‑up)
  - [ ] Кнопка отмены пайплайна в UI `CodeOpsScreen` (остановка текущего `runId`)
  - [ ] Поддержка отмены в агенте (`IAgent.cancel(runId)`/`cancelAll`) и корректные завершающие события (`pipeline_error` с `errorCode: "cancelled"`)
  - [ ] UI‑тесты CodeOpsScreen
    - [ ] Многофайловый предпросмотр и подтверждение запуска
    - [ ] Уточнение языка (Java only); запрет запуска для иных языков
    - [ ] Фоллбек на одиночный файл для legacy‑ответов
  - [ ] Надёжность/ошибки (CodeOps)
    - [ ] Обработка ошибок Docker/сети с дружелюбными сообщениями
    - [ ] Предварительная проверка доступности MCP/Docker перед запуском
    - [ ] Ретраи/повтор вызова MCP при временных сбоях
    - [ ] Улучшенные сообщения в UI (коды ошибок, подсказки, next steps)
    - [ ] Структурированные логи и trace id для корреляции
  - [ ] Расширенные параметры (classpath, args) из UI (опционально)
  - [ ] UI‑конфигурация Docker параметров: `image`, `container_name`, `limits`, `timeout`
  - [ ] E2E‑тест потока CodeOps: генерация → подтверждение → запуск в Docker → отображение результата (smoke‑тест)

- [x] Новый агент‑оркестратор CodeOpsBuilderAgent
  - Реализует унифицированный интерфейс `IAgent`/`IToolingAgent`, композиционно использует `CodeOpsAgent`
  - Поток: генерация классов → вопрос о создании тестов → JUnit4 тесты → запуск в Docker → анализ → рефайн тестов
  - Добавлена документация: `docs/code_ops_builder_agent.md`
  - Добавлены юнит‑тесты: `sample_app/test/code_ops_builder_agent_test.dart`
  - [x] Стриминг для CodeOpsBuilderAgent
    - Реализован `start()` со `Stream<AgentEvent>` (прогресс шагов, этапы пайплайна, промежуточные сообщения)
    - Интегрирован стрим в UI `sample_app/lib/screens/code_ops_screen.dart`:
      - индикатор прогресса пайплайна
      - отображение текущего шага и live‑лог событий
      - диалог подтверждения создания тестов (да/нет) в рамках потокового сценария
    - TODO: поддержка отмены пайплайна (API отмены и корректное завершение стрима)
    - Покрытие тестами:
      - добавлены unit‑тесты для новых DTO (`AgentEvent`, `AgentStage`, `AgentSeverity`)
      - обновлены тесты `CodeOpsBuilderAgent` (включен флаг streaming)
      - интеграционные smoke‑тесты стрима — TODO (планируются отдельно)

  ### Вопросы для уточнения (CodeOps)
  - Начать с UI‑тестов `CodeOpsScreen` и небольшого рефакторинга (DI) для мокирования `CodeOpsAgent`?
  - Вынести утилиты парсинга карточек/фенсов (`_decodeCodeCard`, `_stripCodeFencesGlobal`) в `lib/utils/` и покрыть юнит‑тестами?
  - Добавлять сейчас preflight‑проверки MCP/Docker (включён ли MCP, валиден ли URL, ping инструмента) и улучшенные сообщения об ошибках, или отложить?

## Деплой и эксплуатация
- [ ] Плейбуки для VPS: подготовка окружения (Node, JDK 17, systemd, Docker), развертывание
- [ ] Скрипты обновления (zero‑downtime перезапуск сервисов)
- [ ] Мониторинг и алерты (ошибки MCP, отсутствие уведомлений, рост open issues)

## Идеи на будущее
- [ ] Фильтрация/агрегация: уведомления по меткам (labels), по исполнителям, по SLA
- [ ] Расширение MCP: инструмент `list_issues` c фильтрами; `create_comment` для авто‑комментариев
- [ ] Мульти‑канальные уведомления: Slack/Webhook (в дополнение к Telegram)
